# Allows us to install Python versions newer than 3.10
- name: Add Python PPA Key
  become: True
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: F23C5A6CF475977595C89F51BA6932366A755776
    keyring: /usr/share/keyrings/deadsnakes-ppa-keyring.gpg

- name: Add Python PPA
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/deadsnakes-ppa-keyring.gpg] http://ppa.launchpad.net/deadsnakes/ppa/ubuntu {{ ubuntu_release }} main

# Allows us to install G++13, so we can use an updated libstdc++ which provides more standard library features (C++20)
- name: Add GCC PPA Key
  become: True
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 60C317803A41BA51845E371A1E9377A2BA9EF27F
    keyring: /usr/share/keyrings/ubuntu-toolchain-r-ppa-keyring.gpg

- name: Add GCC PPA
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/ubuntu-toolchain-r-ppa-keyring.gpg] http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu {{ ubuntu_release }} main

- name: Add LLVM APT Key
  become: True
  apt_key:
    url: https://apt.llvm.org/llvm-snapshot.gpg.key
    id: 6084F3CF814B57C1CF12EFD515CF4D18AF4F7421
    keyring: /usr/share/keyrings/llvm-archive-keyring.gpg

# Allows us to install LLVM tools
- name: Add LLVM APT List
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] https://apt.llvm.org/{{ ubuntu_release }}/ llvm-toolchain-{{ ubuntu_release }}-18 main
    filename: llvm

- name: Add CMake APT Key
  become: True
  apt_key:
    url: https://apt.kitware.com/keys/kitware-archive-latest.asc
    id: 4DBEBE3EEC96E7B8C6EC5BE99E92FDC6C5B9BA75
    keyring: /usr/share/keyrings/kitware-archive-keyring.gpg

# Allows us to install CMake versions newer than 3.22
- name: Add CMake APT List
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ {{ ubuntu_release }} main
    filename: kitware

- name: Add ROS APT Key
  become: True
  apt_key:
    url: https://raw.githubusercontent.com/ros/rosdistro/master/ros.key
    id: C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
    keyring: /usr/share/keyrings/ros-archive-keyring.gpg

- name: Add ROS APT List
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu {{ ubuntu_release }} main
    filename: ros

- name: Add NodeSource APT Key
  become: True
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    keyring: /usr/share/keyrings/nodesource-keyring.gpg

- name: Add NodeSource APT List
  become: True
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/nodesource-keyring.gpg] https://deb.nodesource.com/node_24.x nodistro main
    filename: nodesource

- name: Upgrade APT Packages
  become: True
  apt:
    cache_valid_time: 604800
    upgrade: dist

- name: Install APT Packages
  become: True
  apt:
    cache_valid_time: 604800
    state: latest
    name:
      - zsh
      - fzf
      - sudo
      - cmake
      - ccache # Caches intermediate build files, speeds up compilation over time
      - ninja-build # Faster than make
      - tmux
      - htop
      - curl
      - unzip
      - rsync
      - shellcheck
      - python3-pip
      - python3-dev
      - python3-venv
      - python3-rosdep
      - clang-18
      - clangd-18
      - clang-tidy-18
      - clang-format-18
      - lld-18
      - lldb-18
      - gcc-13
      - g++-13
      - libbullet-dev
      - libglfw3-dev
      - libx11-xcb-dev
      - libnl-3-dev
      - libnl-route-3-dev
      - libtbb-dev
      - libassimp-dev
      - libeigen3-dev
      - libopencv-dev
      - libgstreamer1.0-dev
      - libgstreamer-plugins-base1.0-dev
      - vainfo
      - x264
      - ros-humble-ros-base
      - ros-humble-rviz2
      - ros-humble-xacro
      - ros-humble-magic-enum
      - ros-humble-rtcm-msgs
      # TODO (ali): why does this need to be installed manually
      - libboost-dev
      - qtbase5-dev
      - qtmultimedia5-dev
      - libqt5multimedia5-plugins
      - python3-pyqt5
      - nodejs

- name: Build and Install Manif
  become: True
  command: ./scripts/build_manif.sh
  args:
    chdir: "{{ ansible_env.HOME }}/ros2_ws/src/mrover/"
    creates: /usr/local/lib/python3.10/dist-packages/manifpy/__init__.py

- name: Build and Install Dawn
  become: True
  command: ./scripts/build_dawn.sh
  args:
    chdir: "{{ ansible_env.HOME }}/ros2_ws/src/mrover/"
    creates: "{{ ansible_env.HOME }}/ros2_ws/src/mrover/deps/dawn/out/Release/src/dawn/native/libwebgpu_dawn.so"

- name: Initialize rosdep
  become: True
  command: rosdep init
  args:
    # This command will be skipped if this file already exists
    creates: /etc/ros/rosdep/sources.list.d/20-default.list

- name: Update rosdep
  command: rosdep update

# - name: Install ROS Packages
#   # command: rosdep install --from-paths {{ ros2_workspace }}/src --ignore-src -y --rosdistro={{ ros_distro }}

- name: Set G++ 13 as Default
  become: True
  alternatives:
    name: g++
    path: /usr/bin/g++-13
    link: /usr/bin/g++
    priority: 130

- name: Set GCC 13 as Default
  become: True
  alternatives:
    name: gcc
    path: /usr/bin/gcc-13
    link: /usr/bin/gcc
    priority: 130

- name: Set clang++18 as Default
  become: True
  alternatives:
    name: clang++
    path: /usr/bin/clang++-18
    link: /usr/bin/clang++
    priority: 180

- name: Set clang-18 as Default
  become: True
  alternatives:
    name: clang
    path: /usr/bin/clang-18
    link: /usr/bin/clang
    priority: 180

- name: Set clangd 18 as Default
  become: True
  alternatives:
    name: clangd
    path: /usr/bin/clangd-18
    link: /usr/bin/clangd
    priority: 180

- name: Set LLD 18 as Default
  become: True
  alternatives:
    name: lld
    path: /usr/bin/lld-18
    link: /usr/bin/lld
    priority: 180

- name: Set clang-tidy 18 as Default
  become: True
  alternatives:
    name: clang-tidy
    path: /usr/bin/clang-tidy-18
    link: /usr/bin/clang-tidy
    priority: 180

- name: Setup Python Virtual Environment
  pip:
    name:
      # Installs from pyproject.toml
      - "{{ ros2_workspace }}/src/mrover[dev]"
    virtualenv: "{{ ros2_workspace }}/src/mrover/venv"
    virtualenv_command: /usr/bin/python3.10 -m venv

- name: Install Chromium
  become: True
  snap:
    name: chromium

- name: Download Bun installer
  get_url:
    url: https://bun.sh/install
    dest: /tmp/bun_install.sh
    mode: '0755'

- name: Install or Upgrade Bun
  shell: /tmp/bun_install.sh
  args:
    executable: /bin/bash
  environment:
    BUN_INSTALL: "{{ ansible_env.HOME }}/.bun"

- name: Install Bun Packages
  command: "{{ ansible_env.HOME }}/.bun/bin/bun install"
  args:
    chdir: "{{ ansible_env.HOME }}/ros2_ws/src/mrover/teleoperation/basestation_gui/frontend"
